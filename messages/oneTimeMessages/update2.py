import os
import logging
import asyncio
from telegram import Bot
from db import get_active_users

TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
bot = Bot(token=TELEGRAM_BOT_TOKEN)

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def send_message_to_users():
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_until_complete(async_send_message_to_users())

async def async_send_message_to_users():
    """ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ–º –∞–∫—Ç–∏–≤–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º. """
    users = get_active_users()

#    message = (
#        "<b>‚ö†Ô∏è –ú–∞—î–º–æ –Ω–µ–≤–µ–ª–∏—á–∫–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —â–æ–¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –±–æ—Ç–∞.</b>\n\n"
#        "–£ –ø‚Äô—è—Ç–Ω–∏—Ü—é –≤–≤–µ—á–µ—Ä—ñ –±–∞–≥–∞—Ç–æ –∑ –≤–∞—Å –æ—Ç—Ä–∏–º–∞–ª–∏ —Å–µ—Ä—ñ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ –≤–∏–ø–ª–∞—Ç–∏ üí∏. "
#        "–¶–µ —Å—Ç–∞–ª–æ—Å—è —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É, —è–∫–∞ –≤–∏–Ω–∏–∫–ª–∞ –ø—ñ–¥ —á–∞—Å —Ä–æ–∑—Ä–æ–±–∫–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –±–æ—Ç–∞.\n\n"
#        "–ú–∏ –≤–∂–µ –≤—Å–µ –≤–∏–ø—Ä–∞–≤–∏–ª–∏ üõ†Ô∏è\n\n"
#        "–í—ñ–¥—Ç–µ–ø–µ—Ä —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö –±—É–¥–µ –≤–∫–∞–∑–∞–Ω–æ <b>–ø–µ—Ä—ñ–æ–¥, –∑–∞ —è–∫–∏–π –∑–¥—ñ–π—Å–Ω–µ–Ω–æ –æ–ø–ª–∞—Ç—É</b>, "
#        "—Ç–æ–∂ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å—Ç–∞–Ω–µ –∑—Ä–æ–∑—É–º—ñ–ª—ñ—à–æ—é —ñ –∑—Ä—É—á–Ω—ñ—à–æ—é.\n\n"
#        "–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à–µ —Ç–µ—Ä–ø—ñ–Ω–Ω—è, –ø—ñ–¥—Ç—Ä–∏–º–∫—É —ñ —Ä–æ–∑—É–º—ñ–Ω–Ω—è üôè\n"
#    )
    message = (
        "üå∏ <b>–•—Ä–∏—Å—Ç–æ—Å –í–æ—Å–∫—Ä–µ—Å!</b> üå∏\n\n"
        "–í—ñ—Ç–∞—î–º–æ –≤–∞—Å –∑—ñ <b>—Å–≤—ñ—Ç–ª–∏–º —Å–≤—è—Ç–æ–º –í–µ–ª–∏–∫–æ–¥–Ω—è</b>! ‚ú®\n"
        "–ù–µ—Ö–∞–π —É –≤–∞—à–æ–º—É —Å–µ—Ä—Ü—ñ –∑–∞–≤–∂–¥–∏ –±—É–¥–µ <b>–≤—ñ—Ä–∞</b>, —É –¥—É—à—ñ ‚Äî <b>—Å–ø–æ–∫—ñ–π</b>,\n"
        "—É –¥–æ–º—ñ ‚Äî <b>–∑–∞—Ç–∏—à–æ–∫</b>, –∞ –ø–æ—Ä—É—á ‚Äî <b>–Ω–∞–π—Ä—ñ–¥–Ω—ñ—à—ñ –ª—é–¥–∏</b> üíõ\n\n"
        "–ù–µ—Ö–∞–π —Ü—è –ü–∞—Å—Ö–∞ –ø—Ä–∏–Ω–µ—Å–µ –≤–∞–º –±–∞–≥–∞—Ç–æ <b>—Ä–∞–¥—ñ—Å–Ω–∏—Ö –º–æ–º–µ–Ω—Ç—ñ–≤</b> üôè\n\n"
        "ü•öüê£ <i>–°–º–∞—á–Ω–æ—ó –ø–∞—Å–∫–∏, –¥–æ–±—Ä–∏—Ö —Å–≤—è—Ç —ñ –º–∏—Ä–Ω–æ–≥–æ –Ω–µ–±–∞ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ—é!</i>\n\n"
        "–ó –Ω–∞–π—â–∏—Ä—ñ—à–∏–º–∏ –ø–æ–±–∞–∂–∞–Ω–Ω—è–º–∏, <b>@FreightTransportPartnerBot</b> ü§ç"
    )


    for user in users:
        telegram_id = user.get('telegram_id')
        employee_name = user.get('employee_name')
        if telegram_id:
            try:
                await bot.send_message(chat_id=telegram_id, text=message, parse_mode='HTML')
                logging.info(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: {employee_name} (Telegram ID: {telegram_id})")
            except Exception as e:
                logging.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è {employee_name}: {e}")
        else:
            logging.warning(f"‚ö†Ô∏è –í—ñ–¥—Å—É—Ç–Ω—ñ–π Telegram ID –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {employee_name}")
