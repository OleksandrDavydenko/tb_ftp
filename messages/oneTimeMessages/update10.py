import os
import logging
import asyncio
from telegram import Bot
from db import get_active_users

TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
bot = Bot(token=TELEGRAM_BOT_TOKEN)

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def send_message_to_users():
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_until_complete(async_send_message_to_users())

async def async_send_message_to_users():
    """ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ–º –∞–∫—Ç–∏–≤–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º. """
    users = get_active_users()
    message = (
        "üéâ <b>–§–¢–ü ‚Äî 14 —Ä–æ–∫—ñ–≤!</b>\n\n"
        "–°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –≤—ñ–¥–∑–Ω–∞—á–∞—î–º–æ –æ—Å–æ–±–ª–∏–≤—É –¥–∞—Ç—É ‚Äî <b>14 —Ä–æ–∫—ñ–≤ —É—Å–ø—ñ—Ö—ñ–≤, –ø–µ—Ä–µ–º–æ–≥ —ñ —Ä–æ–∑–≤–∏—Ç–∫—É</b>. "
        "–¶–µ —à–ª—è—Ö, —è–∫–∏–π –º–∏ –ø—Ä–æ–π—à–ª–∏ —Ä–∞–∑–æ–º, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—á–∏ —Å–º—ñ–ª–∏–≤—ñ —ñ–¥–µ—ó –Ω–∞ —Ä–µ–∞–ª—å–Ω—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è.\n\n"
        "üë• –ó–∞ —Ü–µ–π —á–∞—Å –º–∏ –≤–∏—Ä–æ—Å–ª–∏ —É –≤–µ–ª–∏–∫—É —Ç–∞ –∑–≥—É—Ä—Ç–æ–≤–∞–Ω—É –∫–æ–º–∞–Ω–¥—É –∑ <b>166 –ø—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª—ñ–≤</b>. "
        "–ö–æ–∂–µ–Ω —ñ–∑ –≤–∞—Å —â–æ–¥–Ω—è —Ä–æ–±–∏—Ç—å –≤–Ω–µ—Å–æ–∫ —É —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ —Å–∏–ª—É –∫–æ–º–ø–∞–Ω—ñ—ó. "
        "–°–∞–º–µ –∑–∞–≤–¥—è–∫–∏ –≤–∞—à—ñ–π –ø—Ä–∞—Ü—ñ, –µ–Ω–µ—Ä–≥—ñ—ó —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ –§–¢–ü —Å—Ç–∞–ª–∞ —Ç–∏–º, –∫–∏–º —î —Å—å–æ–≥–æ–¥–Ω—ñ.\n\n"
        "–ù–∞—à —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç:\n"
        "‚Ä¢ <b>–ö–æ–º–∞–Ω–¥–∞</b> ‚Äî —Ä–∞–∑–æ–º –º–∏ –¥–æ–ª–∞—î–º–æ –≤–∏–∫–ª–∏–∫–∏, –ø—ñ–¥—Ç—Ä–∏–º—É—î–º–æ –æ–¥–Ω–µ –æ–¥–Ω–æ–≥–æ —Ç–∞ —Ä—É—Ö–∞—î–º–æ—Å—è –≤–ø–µ—Ä–µ–¥.\n"
        "‚Ä¢ <b>–†–æ–∑–≤–∏—Ç–æ–∫</b> ‚Äî –º–∏ –Ω–µ –∑—É–ø–∏–Ω—è—î–º–æ—Å—å, –Ω–∞–≤—á–∞—î–º–æ—Å—å —ñ —à—É–∫–∞—î–º–æ –Ω–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ.\n"
        "‚Ä¢ <b>–ö–ª—ñ—î–Ω—Ç–∏</b> ‚Äî –¥–æ–≤—ñ—Ä–∞, —è–∫—É –º–∏ —â–æ–¥–Ω—è –∑–∞—Å–ª—É–∂–µ–Ω–æ –≤–∏–±–æ—Ä—é—î–º–æ.\n"
        "‚Ä¢ <b>–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å</b> ‚Äî –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å —É –∑–∞–≤—Ç—Ä–∞—à–Ω—å–æ–º—É –¥–Ω—ñ —Ç–∞ –º—ñ—Ü–Ω–∞ –æ–ø–æ—Ä–∞ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ.\n"
        "‚Ä¢ <b>–Ü–Ω–Ω–æ–≤–∞—Ü—ñ—ó</b> ‚Äî —Å—É—á–∞—Å–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è, —è–∫—ñ —Ä–æ–±–ª—è—Ç—å –Ω–∞—Å —Å–∏–ª—å–Ω—ñ—à–∏–º–∏ –∑–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤.\n\n"
        "üí° <b>–ö–æ–∂–µ–Ω —ñ–∑ –≤–∞—Å ‚Äî —á–∞—Å—Ç–∏–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—ó –§–¢–ü</b>. –†–∞–∑–æ–º –º–∏ –¥–æ–≤–µ–ª–∏, —â–æ –Ω–∞–≤—ñ—Ç—å –Ω–∞–π–∞–º–±—ñ—Ç–Ω—ñ—à—ñ —Ü—ñ–ª—ñ —Å—Ç–∞—é—Ç—å —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—é, "
        "—è–∫—â–æ –¥—ñ—è—Ç–∏ —î–¥–∏–Ω–æ—é –∫–æ–º–∞–Ω–¥–æ—é. –ü–æ–ø–µ—Ä–µ–¥—É —â–µ –±—ñ–ª—å—à–µ –≤–∏–∫–ª–∏–∫—ñ–≤, –∞–ª–µ –π –±—ñ–ª—å—à–µ –ø–µ—Ä–µ–º–æ–≥, –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —ñ –Ω–æ–≤–∏—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç—ñ–≤.\n\n"
        "–ù–µ—Ö–∞–π —Ä–æ–±–æ—Ç–∞ —Ç—É—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –Ω–µ –ª–∏—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, –∞ –π –Ω–∞—Ç—Ö–Ω–µ–Ω–Ω—è. "
        "–•–∞–π –∫–æ–∂–µ–Ω –¥–µ–Ω—å —É –§–¢–ü –¥–æ–¥–∞—î –≥–æ—Ä–¥–æ—Å—Ç—ñ –∑–∞ —Ç–µ, —â–æ –º–∏ —Ä–æ–±–∏–º–æ, —ñ –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É. "
        "–ü–∞–º‚Äô—è—Ç–∞–π–º–æ: <b>—É—Å–ø—ñ—Ö –∫–æ–º–ø–∞–Ω—ñ—ó ‚Äî —Ü–µ —É—Å–ø—ñ—Ö –∫–æ–∂–Ω–æ–≥–æ –∑ –Ω–∞—Å</b>. üöÄ\n\n"
        "üíôüíõ –†–∞–∑–æ–º –º–∏ —Å—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Å—å–æ–≥–æ–¥–Ω—ñ —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –Ω–æ–≤—ñ –¥–≤–µ—Ä—ñ –¥–ª—è –∑–∞–≤—Ç—Ä–∞.\n\n"
        "–ó –î–Ω–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –§–¢–ü! 14 —Ä–æ–∫—ñ–≤ ‚Äî —ñ —Ü–µ –ª–∏—à–µ –ø–æ—á–∞—Ç–æ–∫ –≤–µ–ª–∏–∫–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó! ü•Ç‚ú®\n"
    )








    for user in users:
        telegram_id = user.get('telegram_id')
        employee_name = user.get('employee_name')
        if telegram_id:
            try:
                await bot.send_message(chat_id=telegram_id, text=message, parse_mode='HTML')
                logging.info(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: {employee_name} (Telegram ID: {telegram_id})")
            except Exception as e:
                logging.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è {employee_name}: {e}")
        else:
            logging.warning(f"‚ö†Ô∏è –í—ñ–¥—Å—É—Ç–Ω—ñ–π Telegram ID –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {employee_name}")
